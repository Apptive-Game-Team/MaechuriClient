# 전장의 안개 (Fog of War) 시스템

이 문서에서는 클라이언트의 전장의 안개(Fog of War) 시스템의 구현에 대해 설명합니다.

## 1. 개요

전장의 안개 시스템은 플레이어의 시야를 시뮬레이션하여, 플레이어가 직접 보거나 최근에 본 영역만 밝게 표시하고 나머지 영역은 어둡게 가리는 역할을 합니다. 이를 통해 플레이어에게 탐험의 재미와 시각적 몰입감을 제공합니다.

본 시스템은 다음과 같은 주요 기능을 포함합니다.

- **시야 제한**: 플레이어 주변의 일정 범위만 시야에 들어옵니다.
- **장애물 그림자**: 벽과 같은 장애물 뒤는 보이지 않아 그림자가 생깁니다.
- **부드러운 그림자 (Penumbra)**: 장애물 그림자의 가장자리가 부드럽게 표현되어 사실감을 더합니다.
- **성능 최적화**: 수천 개의 DOM 요소 대신 단일 `<canvas>`에 안개를 렌더링하여 높은 성능을 보장합니다.

## 2. 작동 방식

안개 시스템은 매 프레임마다 다음의 과정을 거쳐 시야를 계산하고 화면에 표시합니다.

1.  **시야 중심 설정**: 플레이어의 현재 위치(`player.position`)를 기준으로 타일의 정중앙(`x + 0.5, y + 0.5`)을 시야의 중심점으로 설정합니다.
2.  **가시성 계산 (`calculateVisibleTiles`)**:
    - 시야 범위 내의 모든 미세 격자(Fine-grained Grid) 셀에 대해 가시성을 검사합니다.
    - **슈퍼샘플링 (Supersampling)**: 각 셀의 중앙 및 네 꼭짓점, 총 5개의 지점으로 광선 추적(Raycasting)을 수행합니다.
    - **광선 추적 (Raycasting)**: 플레이어의 시야 중심점에서 각 샘플링 지점까지의 직선 경로상에 시야를 막는 장애물(`Blocks-Vision` 타입의 타일)이 있는지 검사합니다.
    - **가시성 팩터 (Visibility Factor)**: 5개의 광선 중 장애물에 막히지 않고 도달한 광선의 비율을 계산하여 해당 셀의 가시성 팩터(0.0 ~ 1.0)를 결정합니다. 이 팩터 값이 부드러운 그림자 효과를 만들어냅니다.
3.  **렌더링 (`FogOfWar.tsx`)**:
    - 단일 `<canvas>` 요소에 모든 안개 셀을 그립니다.
    - 각 셀의 최종 불투명도(`opacity`)는 다음 두 값 중 더 큰 값으로 결정됩니다.
        - **거리 기반 불투명도**: 플레이어와의 거리에 따라 멀어질수록 점차 어두워집니다.
        - **그림자 불투명도**: `1 - 가시성 팩터` 값으로, 시야에 가려진 정도를 나타냅니다.
    - 틈새 없는 렌더링을 위해 각 셀을 1픽셀씩 겹쳐서 그립니다.

## 3. 주요 파일 및 설정

### 관련 파일

-   **`systems/fogOfWarSystem.ts`**: 게임 루프 내에서 플레이어 위치를 가져와 안개 계산을 트리거하는 시스템.
-   **`utils/raycastUtils.ts`**: 광선 추적 및 가시성 계산의 핵심 로직이 담긴 유틸리티.
-   **`components/FogOfWar.tsx`**: 계산된 안개 데이터를 기반으로 `<canvas>`에 렌더링하는 React 컴포넌트.
-   **`hooks/useGameEntities.ts`**: 게임 시작 시 안개 엔티티의 초기 상태를 설정하는 훅.
-   **`types/index.ts`**: 안개 시스템과 관련된 타입 및 주요 상수를 정의하는 파일.

### 주요 상수 (Tweaking)

`types/index.ts` 파일에서 다음 상수들을 조정하여 안개의 동작과 성능을 변경할 수 있습니다.

-   `VISION_RANGE`: 플레이어의 최대 시야 범위 (타일 단위).
-   `GRADIENT_START_RADIUS`: 시야가 선명하게 유지되는 최소 반경. 이 반경을 넘어서면서부터 안개가 점진적으로 생깁니다.
-   `FOG_RESOLUTION_MULTIPLIER`: 안개 격자의 해상도. 값이 높을수록 안개 가장자리가 부드러워지지만, 계산량이 증가하여 성능에 영향을 줄 수 있습니다. (e.g., `3`은 한 타일을 `3x3`개의 셀로 나눔).

`utils/raycastUtils.ts`의 `calculateVisibleTiles` 함수 내 `samplePoints` 배열을 수정하여 슈퍼샘플링의 품질과 성능을 조절할 수 있습니다. 샘플 포인트 수가 많을수록 그림자 품질이 향상되지만 성능은 저하됩니다.
